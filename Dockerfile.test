# Should match version in integration_test/package.json
FROM cypress/included:10.11.0 as builder

RUN apt update
RUN apt -y install python3-venv gcc python3-dev g++
RUN rm /bin/sh && ln -s /bin/bash /bin/sh
COPY requirements.* /root/
WORKDIR /root
RUN python3 -m venv venv
RUN --mount=type=cache,target=/root/.cache /bin/bash -c "source venv/bin/activate && pip install -r requirements.test.txt -r requirements.dev.txt"

ENTRYPOINT "/bin/bash"

# final stage
FROM builder
WORKDIR /root
COPY requirements.ecosystem.txt /root

RUN --mount=type=cache,target=/root/.cache /bin/bash -c "source venv/bin/activate && pip install -r requirements.ecosystem.txt"
COPY integration_test/package.json /root/integration_test/package.json
COPY integration_test/package-lock.json /root/integration_test/package-lock.json
RUN cd integration_test && npm install

ENTRYPOINT "/bin/bash"
